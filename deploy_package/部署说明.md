# 视频流检测系统 - 部署说明

## 📦 部署包内容

```
deploy_package/
├── detect_video.py           # 主程序入口（含智能缓冲区管理）
├── hand_detector.py          # 手势检测核心模块
├── alarm_video_popup.py      # 报警窗口显示模块
├── mediapipe_hand.py         # MediaPipe手势识别模块
├── config.yaml              # 配置文件
├── requirements.txt         # Python依赖
├── weight/
│   └── notice.md           # 权重文件说明（需单独获取best.pt）
├── 部署说明.md              # 本文件
├── start.bat               # Windows启动脚本
└── start.sh                # Linux/Mac启动脚本
```

## 🚀 快速部署步骤

### 1. 环境要求

- Python 3.8+
- CUDA（可选，用于GPU加速）
- 操作系统：Linux / macOS / Windows

### 2. 安装依赖

```bash
cd deploy_package
pip install -r requirements.txt
```

### 3. 配置系统

编辑 `config.yaml` 文件，配置视频流和检测参数：

```yaml
# 主要配置项
weights: weight/best.pt          # 模型权重路径
device: cuda                      # 使用设备：cuda 或 cpu
confidence: 0.25                  # 检测置信度阈值
alarm_dir: alarms                 # 报警视频保存目录
alarm_duration: 3                 # 报警片段时长（秒）
alarm_frame_threshold: 20         # 触发报警的帧数阈值
cooldown_seconds: 180             # 报警冷却时间（秒）
idle_detect_interval: 2.0         # 空闲时检测间隔（秒），推荐2-4秒

# 视频流配置（示例）
streams:
  - name: A101
    url: rtsp://admin:password@10.0.14.11:554/LiveMedia/ch1/Media1
  - name: A102
    url: rtsp://admin:password@10.0.14.12:554/LiveMedia/ch1/Media1

# 企业微信报警推送（可选）
wechat_webhook_url: "https://qyapi.weixin.qq.com/cgi-bin/webhook/send?key=YOUR_KEY"
```

### 4. 启动系统

#### Linux/Mac:
```bash
chmod +x start.sh
./start.sh
```

#### Windows:
```cmd
./start.bat
```

## ⚙️ 配置说明

### 核心参数

| 参数 | 说明 | 默认值 | 推荐设置 |
|------|------|--------|---------|
| `device` | 计算设备 | `cuda` | GPU环境使用`cuda`，CPU使用`cpu` |
| `confidence` | 检测置信度阈值 | `0.25` | 0.2-0.3 |
| `alarm_dir` | 报警视频保存目录 | `alarms` | - |
| `alarm_duration` | 报警片段时长（秒） | `3` | 3-5秒 |
| `alarm_frame_threshold` | 触发报警所需检测到的帧数 | `20` | 10-30 |
| `cooldown_seconds` | 报警后冷却时间（秒） | `180` | 60-300秒 |
| `idle_detect_interval` | 空闲模式下检测间隔（秒） | `2.0` | **2-4秒**（重要） |

### 视频解码配置

```yaml
video_decode:
  use_hardware_decode: true      # 是否使用硬件解码
  buffer_size: 1                 # 缓冲区大小（推荐1，系统自动管理）
  decode_backend: "ffmpeg"       # 解码后端
  fallback_to_software: true     # 失败后回退到软件解码
  rtsp_transport: "tcp"          # RTSP传输协议（tcp更稳定）
```

**重要说明**：
- `buffer_size`：设置为1即可，系统内置智能缓冲区管理机制
- 系统会根据`idle_detect_interval`和fps自动预测并清空缓冲区
- 避免缓冲区积压导致的延迟问题

### 报警推送配置

支持企业微信群机器人推送：

1. 在企业微信群中创建机器人，获取 Webhook URL
2. 在 `config.yaml` 中配置 `wechat_webhook_url`
3. 触发报警时会自动推送消息和视频文件

## 📊 系统运行

### 检测流程

1. **空闲模式（idle）**：按配置间隔检测，降低CPU占用
   - 自动清空缓冲区以保证实时性
   - 智能预测缓冲区状态，避免读取卡住
2. **活跃模式（active）**：检测到手势后，连续检测3秒
3. **冷却模式（cooldown）**：报警后进入冷却期，避免重复报警

### 实时性保证

系统采用**智能缓冲区管理**机制：
- 根据fps和检测间隔预测缓冲区帧数
- 提前停止grab避免读取卡住
- 确保每次检测都是实时画面（延迟 < 3秒）
- 第150次检测时自动保存带时间戳的图片供验证

### 报警机制

- 在3秒内检测到 ≥ `alarm_frame_threshold` 帧包含手掌朝上姿势时触发报警
- 保存报警视频到 `alarm_dir` 目录
- 弹出报警窗口（可播放、暂停、拖动进度条）
- 推送到企业微信群（如已配置）

### 输出文件

**报警视频**：`{stream_name}_{timestamp}.mp4`
- 例如：`A101_20250117_143025.mp4`
- 保存在`alarm_dir`目录

**实时性验证图片**：`{stream_name}_realtime_check_{timestamp}.jpg`
- 位置：`alarms/realtime_check/`
- 在第150次检测时自动生成
- 用于验证检测画面与实际时间是否匹配

## 🔧 故障排查

### 1. 无法打开视频流

- 检查网络连接和RTSP地址是否正确
- 确认摄像头用户名密码正确
- 检查防火墙设置

### 2. GPU相关错误

- 如无CUDA环境，将 `device` 改为 `cpu`
- 检查PyTorch CUDA版本是否匹配

### 3. 内存或CPU占用过高

- 减少 `streams` 数量，如果一台机负荷不完，可以开多台机，分开负担
- 调整 `idle_detect_interval` 到 3-4 秒（降低检测频率）
- 使用CPU模式时适当增大检测间隔

### 4. 画面延迟问题

**症状**：检测画面与实际时间不匹配

**解决方案**：
1. 检查 `idle_detect_interval` 设置，**推荐2-4秒**
2. 查看 `alarms/realtime_check/` 中的验证图片
3. 如果延迟超过3秒，缩短 `idle_detect_interval`
4. 确保网络带宽足够，RTSP流稳定

## 📝 日志说明

系统运行时会输出详细日志：

```
[A101] 进程启动，流地址: rtsp://...
[A101] 连接成功，fps=25.08, 分辨率=1920x1080, 报警缓冲区长度=75
84                                          # 本次检测间隔的循环次数（包括grab+sleep）
[A101] [idle] 检测#100, 检测间隔: 2.0s, 检测到手: 0个, Palm: False, 读取耗时: 9.5ms, 处理耗时: 63.0ms
[A101] 状态切换: idle -> active (检测到palm)
[A101] !!! 触发报警：3秒内palm帧数25>=20，报警片段: alarms/A101_20250117_143025.mp4
[A101] [实时性验证] 已保存第1250次检测的图片: alarms/realtime_check/A101_realtime_check_20250117_150230.jpg
[WeChat] 文字消息推送成功
[WeChat] 文件消息推送成功
```

**日志解读**：
- 每次检测前显示的数字（如 84）表示本次检测间隔内的总循环次数
- 正常情况下，2秒间隔约为 80-90 次（25fps）
- 如果该值过小（<40）可能存在网络问题

## 📞 技术支持

深圳市第二实验学校 刘树明 13927465776

---

**版本**: 2.0  
**更新日期**: 2025-01-18  
**更新内容**:  
- 新增智能缓冲区管理机制，预测并防止缓冲区积压  
- 优化`idle_detect_interval`默认值为2秒，提升实时性  
- 新增第150次检测自动保存验证图片功能  
- 添加画面延迟问题排查指导
