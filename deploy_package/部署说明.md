# 视频流检测系统 - 部署说明

## 📦 部署包内容

```
deploy_package/
├── detect_video.py           # 主程序入口
├── hand_detector.py          # 手势检测核心模块
├── alarm_video_popup.py      # 报警窗口显示模块
├── mediapipe_hand.py         # MediaPipe手势识别模块
├── config.yaml              # 配置文件
├── requirements.txt         # Python依赖
├── weight/
│   └── notice.md           # 权重文件说明（需单独获取best.pt）
├── 部署说明.md              # 本文件
├── start.bat               # Windows启动脚本
└── start.sh                # Linux/Mac启动脚本
```

## 🚀 快速部署步骤

### 1. 环境要求

- Python 3.8+
- CUDA（可选，用于GPU加速）
- 操作系统：Linux / macOS / Windows

### 2. 安装依赖

```bash
cd deploy_package
pip install -r requirements.txt
```

### 3. 配置系统

编辑 `config.yaml` 文件，配置视频流和检测参数：

```yaml
# 主要配置项
weights: weight/best.pt          # 模型权重路径
device: cuda                      # 使用设备：cuda 或 cpu
confidence: 0.25                  # 检测置信度阈值
alarm_dir: alarms                 # 报警视频保存目录
alarm_duration: 3                 # 报警片段时长（秒）
alarm_frame_threshold: 20         # 触发报警的帧数阈值
cooldown_seconds: 180             # 报警冷却时间（秒）
idle_detect_interval: 30          # 空闲时跳帧检测间隔

# 视频流配置（示例）
streams:
  - name: A101
    url: rtsp://admin:password@10.0.14.11:554/LiveMedia/ch1/Media1
  - name: A102
    url: rtsp://admin:password@10.0.14.12:554/LiveMedia/ch1/Media1

# 企业微信报警推送（可选）
wechat_webhook_url: "https://qyapi.weixin.qq.com/cgi-bin/webhook/send?key=YOUR_KEY"
```

### 4. 启动系统

#### Linux/Mac:
```bash
chmod +x start.sh
./start.sh
```

#### Windows:
```cmd
./start.bat
```

## ⚙️ 配置说明

### 核心参数

| 参数 | 说明 | 默认值 |
|------|------|--------|
| `device` | 计算设备 | `cuda` |
| `confidence` | 检测置信度阈值 | `0.25` |
| `alarm_dir` | 报警视频保存目录 | `alarms` |
| `alarm_duration` | 报警片段时长（秒） | `3` |
| `alarm_frame_threshold` | 触发报警所需检测到的帧数 | `20` |
| `cooldown_seconds` | 报警后冷却时间（秒） | `180` |
| `idle_detect_interval` | 空闲模式下跳帧间隔 | `30` |

### 视频解码配置

```yaml
video_decode:
  use_hardware_decode: true      # 是否使用硬件解码
  buffer_size: 10                # 缓冲区大小
  decode_backend: "ffmpeg"       # 解码后端
  fallback_to_software: true     # 失败后回退到软件解码
  rtsp_transport: "tcp"          # RTSP传输协议（tcp更稳定）
```

### 报警推送配置

支持企业微信群机器人推送：

1. 在企业微信群中创建机器人，获取 Webhook URL
2. 在 `config.yaml` 中配置 `wechat_webhook_url`
3. 触发报警时会自动推送消息和视频文件

## 📊 系统运行

### 检测流程

1. **空闲模式（idle）**：跳帧检测，降低CPU占用
2. **活跃模式（active）**：检测到手势后，连续检测3秒
3. **冷却模式（cooldown）**：报警后进入冷却期，避免重复报警

### 报警机制

- 在3秒内检测到 ≥ `alarm_frame_threshold` 帧包含手掌朝上姿势时触发报警
- 保存报警视频到 `alarm_dir` 目录
- 弹出报警窗口（可播放、暂停、拖动进度条）
- 推送到企业微信群（如已配置）

### 输出文件

报警视频命名格式：`{stream_name}_{timestamp}.mp4`

例如：`A101_20250117_143025.mp4`

## 🔧 故障排查

### 1. 无法打开视频流

- 检查网络连接和RTSP地址是否正确
- 确认摄像头用户名密码正确
- 检查防火墙设置

### 2. GPU相关错误

- 如无CUDA环境，将 `device` 改为 `cpu`
- 检查PyTorch CUDA版本是否匹配

### 3. 内存或CPU占用过高

- 减少 `streams` 数量，如果一台机负荷不完，可以开多台机，分开负担，不影响使用
- 降低 `buffer_size` 值
- 增大 `idle_detect_interval`（跳帧更多）

## 📝 日志说明

系统运行时会输出详细日志：

```
[A101] 进程启动，流地址: rtsp://...
[A101] 连接成功，fps=25, 分辨率=1920x1080, 报警缓冲区长度=75
[A101] [idle] 已处理: 100, 检测到手: 0个, Palm: False
[A101] 状态切换: idle -> active (检测到palm)
[A101] !!! 触发报警：3秒内palm帧数25>=20，报警片段: alarms/A101_20250117_143025.mp4
[WeChat] 文字消息推送成功
[WeChat] 文件消息推送成功
```

## 📞 技术支持

深圳市第二实验学校 刘树明 13927465776

---

**版本**: 1.0  
**更新日期**: 2025-01-17
